---
layout: post
title: '相同网段和不同网段的通信详解'
date: 2020-10-6
author: Warmingzzz
cover: 'http://on2171g4d.bkt.clouddn.com/jekyll-banner.png'
tags: ARP

---

### ARP

在当今的以太网通信中，在ip数据包中有两个必不可少的地址，那就是ip地址和网卡地址（mac地址），在数据包中，无论是ip地址还是mac地址，都有源地址和目标地址，因为通信是双方的，所以就必须拥有双方的地址！



主机A和主机B通信，这时主机A肯定需要封装这些需要发给主机B的数据包，那么对于主机A来说，自己的IP和mac地址肯定是知道的，对于主机B的ip地址也是知道的，要不然通信不了，当有了自己的IP地址，mac地址以及主机B的ip地址之后，主机A在数据包中可以正确写入源ip地址，目标ip地址，源mac地址，最后就是缺目标的mac地址。可是这个时候主机A发现自己根本没有主机b的mac地址，那么怎么办呢？这是主机A就通过比较上面已经封装号的缘ip和目标ip。

#### 在同一个ip网段

通过子网掩码计算一下，发现源ip和目标ip在同一个ip网络内，那么她想要得到目标主机B的mac地址就有办法了，**首先主机A就向本网段发一个ARP请求，这个ARP请求中包含主机A的源ip地址 mac地址，目标B的ip地址，而目标mac地址为广播mac地址（全部为F），因为我们要找的是目标mac地址的数据包，因此在主机*B*收到此*ARP*请求后，立即构建一个包括自己的*MAC*地址的*ARP*回应包，回应给主机*A*，当主机*A*收到这个*ARP*回应后，终于完成了找寻目标*MAC*的重大任务**，从而把目标主机*B*的*MAC*地址正确封装进上面还未封装结束的正准备发给主机*B*的数据包，在这时，源*IP*和源*MAC*以及目标*IP*和目标*MAC*都已正确存在于数据包中，那么这里主机*A*向网络内发出这些数据包，因为目标地址在本网段，**所以本网段所有主机都能收到这个数据包**（这是以太网的特性），最后只有真正的目标主机*B*能够打开这些数据包，在此，同网段两台主机之间的通信就此圆满结束！

### 不同的ip网段

当主机*A*在封装数据包时检测到目标主机并不在本网段，在这时，数据包不能把目标主机的*MAC*地址顺利封装进去，那么就用到另一种方法，**那就是网关**，主机*A*在准备发向主机*B*的数据中，封装好自己的*IP*地址和*MAC*地址，同时也封装好目标主机*B*的*IP*地址，数据包封装到这里，主机*A*就利用上面得到同网段目标主机*B*的方法去请求得到网关的*MAC*地址，同样也是用*ARP*去广播，因为网关必须和本机在同一网段，理所当然，网关能够收到这个*ARP*请求并能正确回应给主机*A*，这时主机*A*在数据包中封装好自己的*IP*地址和*MAC*地址，同时也封装好目标主机*B*的*IP*地址和**网关的*MAC*地址**，把数据包从网卡发出去，因为目标*MAC*是网关的，所以网关收到这个数据包后，发现目标*MAC*是自己，而目标*IP*却是别人，所以它不可以再往上打开这个数据包，它要做的工作就是把这些数据包发给下一跳路由器（如果网关自身就是一台路由器的话），如果网关是一台普通*PC*，那么它就发给路由器，让路由器把这些数据包正确传输到远程目标网络，到达远程网络后，它们的网关再将数据包发给数据包中的目标*IP*，即源主机*A*苦苦寻找的目标主机*B*，从而真正结束不同网络之间的通信，回应的数据包也是用同样的方法到达目的地，在这里，还需要注意的是，**当网关把数据包发给下一跳路由器时，这个数据包必须由网关把目标*MAC*改成下一跳路由器的*MAC*地址（通过*ARP*得到），而源端MAC改成发出端口的MAC地址**，否则下一跳路由器收到目标*MAC*不是自己的数据包，会丢弃不予理睬，下一跳路由器再发给下一跳路由器同样要把目标*MAC*地址改为下一跳路由器的*MAC*地址再发出去！

最后还可以总结出：在网段通信时，数据包中的地址就是源*IP*，目标*IP*，源*MAC*，目标*MAC*，根本用不到网关，而当检测到需要把数据包发到远程网络时，这时，目标*MAC*就必须改变了，在还没有出内网时，**目标*MAC*必须写成网关的*MAC*地址发出去，当网关收到时，再把目标*MAC*地址改成下一跳的*MAC*地址发出去，同时源MAC地址要始终保持为发出端口的MAC地址**（回应报文可以依靠它路由回去），**而源*IP*及目标*IP*不曾改变**（用于判断收到数据包的本机IP和数据包IP是否一致，若一致不转发），就算到达了公网上，目标*MAC*仍然在不断改变着，直到最后，这个数据包到达目标*IP*的网络，最终通信结束！